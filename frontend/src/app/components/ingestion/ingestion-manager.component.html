<div class="container list-container">
  <div class="header">
    <h2>Ingestion Manager</h2>
  </div>
<mat-card class="ingestion-card">
  
  <mat-card-content>
    <form [formGroup]="form" class="ingestion-form">
      <!-- Document IDs as chips (display names) -->
      <mat-form-field class="doc-chip-list" appearance="outline">
        <mat-label>Document IDs</mat-label>

        <!-- Current selection -->
        <mat-chip-grid #chipGrid aria-label="Document IDs">
          @if (documentIdsCtrl.value.length > 0) {
            @for (id of documentIdsCtrl.value; track id) {
              <mat-chip-row (removed)="remove(id)">
                {{ displayChipName(id) }}
                <button matChipRemove [attr.aria-label]="'remove ' + displayChipName(id)">
                  <mat-icon>cancel</mat-icon>
                </button>
              </mat-chip-row>
            }
          }
        </mat-chip-grid>

        <!-- Input (type name or ID) -->
        <input
          matInput
          placeholder="Type a document name or paste an ID"
          [formControl]="docInputCtrl"
          [matChipInputFor]="chipGrid"
          [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
          (matChipInputTokenEnd)="addFromInput($event)"
          [matAutocomplete]="auto"
        />

        <!-- Autocomplete shows names; value is the whole Suggestion -->
        <mat-autocomplete
          #auto="matAutocomplete"
          [displayWith]="displaySuggestionName"
          (optionSelected)="selectSuggestion($event)">
          @for (s of filteredSuggestions(); track s.id) {
            <mat-option [value]="s">{{ s.name }}</mat-option>
          }
        </mat-autocomplete>

        @if (documentIdsCtrl.invalid && (documentIdsCtrl.dirty || documentIdsCtrl.touched)) {
          <mat-error>At least one valid ID is required</mat-error>
        }
      </mat-form-field>

      <!-- Optional reindex toggle
      <mat-checkbox formControlName="reindex">Force re-index (re-create embeddings)</mat-checkbox>
      -->

      <div class="actions">
        <button mat-flat-button color="primary" (click)="trigger()" [disabled]="isLoading || form.invalid">
          Trigger Ingestion
        </button>
        <button mat-stroked-button (click)="refresh()" [disabled]="isLoading">Refresh</button>
      </div>
    </form>

    @if (isLoading) {
      <div class="mt-16">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
      </div>
    }

    @if (!isLoading && jobs.length > 0) {
      <table mat-table [dataSource]="jobs" class="w-100 mt-16">
        <!-- Job ID -->
        <ng-container matColumnDef="jobId">
          <th mat-header-cell *matHeaderCellDef> Job ID </th>
          <td mat-cell *matCellDef="let row"><code>{{ row.id }}</code></td>
        </ng-container>

        <!-- Docs -->
        <ng-container matColumnDef="docs">
          <th mat-header-cell *matHeaderCellDef> Documents </th>
          <td mat-cell *matCellDef="let row">
            @if (row.ingestedDocuments.length > 0) {
              <mat-chip-set>
                @for (d of row.ingestedDocuments; track d.id) {
                  <mat-chip selected>{{ d.name }}</mat-chip>
                }
              </mat-chip-set>
            } @else {
              <em>â€”</em>
            }
          </td>
        </ng-container>

        <!-- Status -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef> Status </th>
          <td mat-cell *matCellDef="let row">
            <mat-chip
              [color]="row.status === 'SUCCEEDED' ? 'primary'
                        : row.status === 'FAILED' ? 'warn' : ''">
              {{ row.status | uppercase }}
            </mat-chip>
          </td>
        </ng-container>

        <!-- Progress (optional) -->
        <ng-container matColumnDef="progress">
          <th mat-header-cell *matHeaderCellDef> Progress </th>
          <td mat-cell *matCellDef="let row">
            <mat-progress-bar [value]="row.progress || 0" mode="determinate"></mat-progress-bar>
            <small>{{ row.progress || 0 }}%</small>
          </td>
        </ng-container>

        <!-- Updated -->
        <ng-container matColumnDef="updatedAt">
          <th mat-header-cell *matHeaderCellDef> Updated </th>
          <td mat-cell *matCellDef="let row">{{ row.updatedAt | date:'medium' }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
      </table>
    }

    @if (!isLoading && jobs.length === 0) {
      <div class="mt-16"><em>No jobs yet. Trigger an ingestion to get started.</em></div>
    }
  </mat-card-content>
</mat-card>
</div>